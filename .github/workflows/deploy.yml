name: Build and Deploy Stage

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  issues: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get or Make Extension ID
        env:
          CHUB_AUTH_TOKEN: ${{ secrets.CHUB_AUTH_TOKEN }}
          EXTENSION_ID: ${{ secrets.EXTENSION_ID }}
        run: |
          mkdir -p public/       
          touch public/chub_meta.yaml  
          if grep -q "github_path:" public/chub_meta.yaml; then
            echo "Repo path already in metadata file."
          else
            echo "Writing github path 'https://github.com/${{ github.repository }}' to metadata file."
            echo "github_path: 'https://github.com/${{ github.repository }}'" >> public/chub_meta.yaml
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add public/chub_meta.yaml
            git commit -m "Add github_path to chub_meta.yaml" || true
            git push
          fi
          if [ "${{ secrets.EXTENSION_ID }}" == "" ]; then
             echo "Secret EXTENSION_ID does not exist; attempting to read from file"
             EXTENSION_ID=$(grep '^extension_id:' public/chub_meta.yaml | cut -d ':' -f2 | tr -d " '\"")
             if [ "${EXTENSION_ID}" == "" ]; then
                echo "Extension ID not present in public/chub_meta.yaml extension_id field either. Creating new project."
                sudo apt-get install jq
                EXTENSION_ID=""
                curl -H "CH-API-KEY: ${{ secrets.CHUB_AUTH_TOKEN }}" -H "Content-Type: application/json" --request POST --data '{"name":"${{ github.event.repository.name }}"}'  https://api.chub.ai/extensions  -o creation.json
                EXTENSION_ID=$(jq -r '.id_v2' creation.json)
                if [ "${EXTENSION_ID}" == "" ] || [ "${EXTENSION_ID}" == "null" ]; then
                  echo "Extension ID creation failed; is your CHUB_AUTH_TOKEN secret set for this project?"
                  exit 1
                fi
                echo "extension_id: '${EXTENSION_ID}'" >> public/chub_meta.yaml
                git config --local user.email "action@github.com"
                git config --local user.name "GitHub Action"
                git add public/chub_meta.yaml
                git commit -m "Add new Extension ID to chub_meta.yaml" || true
                git push
             else
                echo "Extension ID found in public/chub_meta.yaml."
             fi
          else
             EXTENSION_ID=${{ secrets.EXTENSION_ID }}
          fi
          echo "EXTENSION_ID=${EXTENSION_ID}" >> $GITHUB_ENV
          

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.11.1'
          cache: 'yarn'

      - name: Install dependencies
        run: |-
          yarn install --frozen-lockfile

      - name: Build stage
        run: |-
          yarn build

      - name: Deploy to Chub
        env:
          CHUB_AUTH_TOKEN: ${{ secrets.CHUB_AUTH_TOKEN }}
        run: |
          if [ -z "$CHUB_AUTH_TOKEN" ]; then
            echo "Warning: CHUB_AUTH_TOKEN not set. Skipping deployment."
            exit 0
          fi
          
          cd dist
          
          # Create deployment package
          zip -r ../stage.zip *
          cd ..
          
          # Upload to Chub
          curl -H "CH-API-KEY: ${{ secrets.CHUB_AUTH_TOKEN }}" -F "file=@stage.zip" https://api.chub.ai/extension/${{ env.EXTENSION_ID }}/upload
